<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد پیشرفته مدیریت تعمیرات - علوم پزشکی مازندران</title>
    
    <!-- کتابخانه‌های ضروری -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transition: 0.3s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 95%; max-width: 500px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        th { position: sticky; top: 0; background: #f1f5f9; z-index: 10; }
        /* رنگ بندی وضعیت ها */
        .status-approve { color: #15803d; background: #dcfce7; }
        .status-reject { color: #b91c1c; background: #fee2e2; }
        .status-pending { color: #854d0e; background: #fef9c3; }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- هدر -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-6 rounded-2xl shadow-lg mb-8 text-center relative overflow-hidden">
        <div class="relative z-10">
            <h1 class="text-3xl font-bold mb-2">سامانه مدیریت و تحلیل تعمیرات آمبولانس</h1>
            <p class="text-blue-100 text-lg">دانشگاه علوم پزشکی مازندران</p>
        </div>
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/medical-icons.png')]"></div>
    </header>

    <!-- بارگذاری فایل -->
    <div id="uploadSection" class="card p-10 max-w-3xl mx-auto text-center border-2 border-dashed border-blue-300">
        <div class="mb-6">
            <div class="mx-auto h-20 w-20 bg-blue-50 rounded-full flex items-center justify-center mb-4">
                <svg class="h-10 w-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">بارگذاری فایل اکسل گزارشات</h2>
            <p class="text-gray-500 mt-2">فایل خروجی سامانه (با فرمت xls یا xlsx) را اینجا رها کنید یا انتخاب نمایید</p>
        </div>
        <div class="flex justify-center gap-4 flex-wrap">
            <input type="file" id="fileInput" accept=".xls,.xlsx" class="file:bg-blue-600 file:text-white file:border-0 file:rounded-full file:px-4 file:py-2 file:cursor-pointer hover:file:bg-blue-700 text-gray-500 bg-gray-50 rounded-full border border-gray-300 pr-1 cursor-pointer w-full max-w-sm" />
            <button onclick="processExcelFile()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2 rounded-full font-bold shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                <span>شروع آنالیز</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </div>
        <p id="errorMsg" class="text-red-500 mt-4 text-sm font-bold hidden"></p>
    </div>

    <!-- داشبورد اصلی -->
    <div id="dashboard" class="hidden space-y-8 mt-8">
        
        <!-- آمار کلی -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="card p-6 border-r-4 border-blue-500 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">کل درخواست‌ها</p><h3 class="text-3xl font-bold text-gray-800" id="totalCount">0</h3></div>
                <div class="bg-blue-100 p-3 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div>
            </div>
            <div class="card p-6 border-r-4 border-emerald-500 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">شهر‌های فعال</p><h3 class="text-3xl font-bold text-gray-800" id="cityCount">0</h3></div>
                <div class="bg-emerald-100 p-3 rounded-full"><svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div>
            </div>
            <div class="card p-6 border-r-4 border-amber-500 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">بیشترین درخواست</p><h3 class="text-xl font-bold text-gray-800 truncate" id="topCity">-</h3></div>
                <div class="bg-amber-100 p-3 rounded-full"><svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></div>
            </div>
            <div class="card p-6 border-r-4 border-purple-500 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">تاریخ آخرین ثبت</p><h3 class="text-xl font-bold text-gray-800" id="lastDate">-</h3></div>
                <div class="bg-purple-100 p-3 rounded-full"><svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
            </div>
        </div>

        <!-- نمودار و جدول خلاصه -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">نمودار درخواست‌ها به تفکیک شهر</h3>
                <div class="relative h-80">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="card p-6 overflow-hidden flex flex-col">
                <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">جدول آماری شهرها</h3>
                <div class="overflow-y-auto flex-grow h-80">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-100 text-gray-600 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">نام شهر</th>
                                <th class="px-4 py-3 text-center">تعداد درخواست</th>
                                <th class="px-4 py-3 text-center">درصد</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- بخش مدیریت و جزئیات -->
        <div id="detailSection" class="card p-6 border-t-4 border-indigo-500">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    میز کار مدیریت درخواست‌ها
                </h2>
                <div class="flex gap-2">
                    <button onclick="exportData('excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 text-sm transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        دانلود اکسل (با وضعیت تایید)
                    </button>
                    <button onclick="exportData('image')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 text-sm transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        دانلود تصویر گزارش
                    </button>
                </div>
            </div>

            <!-- فیلترها -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-xl mb-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">فیلتر بر اساس شهر:</label>
                    <select id="cityFilter" onchange="applyFilters()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">همه شهرها</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">فیلتر زمانی / تعداد:</label>
                    <select id="timeFilter" onchange="applyFilters()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="all">تمام سوابق</option>
                        <option value="3">۳ درخواست آخر</option>
                        <option value="5">۵ درخواست آخر</option>
                        <option value="10">۱۰ درخواست آخر</option>
                        <option value="m1">یک ماه اخیر</option>
                        <option value="m2">دو ماه اخیر</option>
                        <option value="m3">سه ماه اخیر</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg w-full text-center font-bold">
                        تعداد نمایش: <span id="filteredCount">0</span>
                    </div>
                </div>
            </div>

            <!-- جدول اصلی -->
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="w-full text-sm text-right bg-white" id="mainTable">
                    <thead class="bg-gray-100 text-gray-700 uppercase font-bold">
                        <tr>
                            <th class="px-4 py-3 w-10">عملیات</th>
                            <th class="px-4 py-3 cursor-pointer hover:bg-gray-200" onclick="sortTable(1)">نام شهر ⇅</th>
                            <th class="px-4 py-3 cursor-pointer hover:bg-gray-200" onclick="sortTable(2)">کد آمبولانس (شناسه) ⇅</th>
                            <th class="px-4 py-3 cursor-pointer hover:bg-gray-200" onclick="sortTable(3)">تاریخ ثبت ⇅</th>
                            <th class="px-4 py-3">وضعیت درخواست</th>
                            <th class="px-4 py-3">تاریخ ارجاع</th>
                            <th class="px-4 py-3">شناسه درخواست</th>
                            <th class="px-4 py-3">کاربر درخواست دهنده</th>
                            <th class="px-4 py-3 w-48 text-center bg-yellow-50">تاییدیه مدیریت</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody" class="divide-y divide-gray-100">
                        <!-- سطرها با جاوااسکریپت پر میشوند -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- مودال پاپ آپ -->
    <div id="actionModal" class="modal">
        <div class="modal-content relative">
            <button onclick="closeModal()" class="absolute left-4 top-4 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">بررسی و تایید درخواست</h3>
            
            <div class="mb-4">
                <p class="text-sm text-gray-500 mb-1">شناسه درخواست:</p>
                <p id="modalReqId" class="font-mono font-bold text-lg text-blue-600">---</p>
            </div>

            <div class="mb-6 space-y-3">
                <label class="block text-sm font-bold text-gray-700">وضعیت تایید:</label>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-green-50 w-1/2 justify-center transition has-[:checked]:bg-green-100 has-[:checked]:border-green-500">
                        <input type="radio" name="status" value="تایید شده" class="w-4 h-4 text-green-600" checked>
                        <span class="mr-2 text-green-700 font-bold">تایید درخواست</span>
                    </label>
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-red-50 w-1/2 justify-center transition has-[:checked]:bg-red-100 has-[:checked]:border-red-500">
                        <input type="radio" name="status" value="رد شده" class="w-4 h-4 text-red-600">
                        <span class="mr-2 text-red-700 font-bold">رد درخواست</span>
                    </label>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">توضیحات مدیریتی:</label>
                <textarea id="modalComment" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="توضیحات تکمیلی را اینجا بنویسید..."></textarea>
            </div>

            <button onclick="saveAction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition">ثبت تغییرات</button>
        </div>
    </div>

    <script>
        // متغیرهای سراسری
        let rawData = [];
        let filteredData = [];
        let managerActions = {}; // ذخیره وضعیت تایید/رد: { reqId: { status, comment } }
        let chartInstance = null;

        // نقشه برداری نام ستون ها (برای رفع مشکل نام شهر)
        let COL_MAP = {
            ID: 'شماره درخواست',
            AMBULANCE_ID: 'شناسه ماشین آلات',
            CITY: 'نام شهر', // کلید نرمال شده
            REQUESTER: 'کاربر درخواست دهنده',
            STATUS: 'وضعیت تعمیراتی',
            DATE_REQ: 'تاریخ ثبت درخواست',
            DATE_REF: 'تاریخ ارجاع به تعمیرگاه'
        };

        // 1. پردازش فایل اکسل
        function processExcelFile() {
            const fileInput = document.getElementById('fileInput');
            const errorMsg = document.getElementById('errorMsg');
            
            if (fileInput.files.length === 0) {
                errorMsg.innerText = "لطفا ابتدا یک فایل انتخاب کنید.";
                errorMsg.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) throw new Error("فایل خالی است");

                    // نرمال سازی نام ستون ها (حذف فاصله های اضافی)
                    rawData = jsonData.map(row => {
                        let newRow = {};
                        Object.keys(row).forEach(key => {
                            let cleanKey = key.trim(); // حذف فاصله از ابتدا و انتها
                            newRow[cleanKey] = row[key];
                        });
                        return newRow;
                    });

                    // بررسی وجود ستون نام شهر
                    const sampleRow = rawData[0];
                    let cityColFound = false;
                    // تلاش برای یافتن ستونی که شامل کلمه "شهر" باشد
                    for(let key in sampleRow) {
                        if(key.includes("شهر")) {
                            COL_MAP.CITY = key;
                            cityColFound = true;
                            break;
                        }
                    }

                    if(!cityColFound) {
                        alert("هشدار: ستون 'نام شهر' یافت نشد. لطفا فایل را بررسی کنید.");
                    }

                    // مقداردهی اولیه وضعیت تایید
                    rawData.forEach(item => {
                        const id = item[COL_MAP.ID];
                        if (!managerActions[id]) {
                            managerActions[id] = { status: 'تایید شده', comment: '' };
                        }
                    });

                    initDashboard();
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');

                } catch (err) {
                    console.error(err);
                    errorMsg.innerText = "خطا در خواندن فایل. مطمئن شوید فایل اکسل صحیح است.";
                    errorMsg.classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        // 2. راه اندازی داشبورد
        function initDashboard() {
            // محاسبات آماری
            const cities = {};
            let maxDate = '';

            rawData.forEach(row => {
                const city = row[COL_MAP.CITY] || 'نامشخص';
                cities[city] = (cities[city] || 0) + 1;
                
                const date = row[COL_MAP.DATE_REQ];
                if (date && date > maxDate) maxDate = date;
            });

            // بروزرسانی کارت ها
            document.getElementById('totalCount').innerText = rawData.length.toLocaleString('fa-IR');
            document.getElementById('cityCount').innerText = Object.keys(cities).length.toLocaleString('fa-IR');
            document.getElementById('lastDate').innerText = maxDate || '-';
            
            // پیدا کردن بیشترین شهر
            let topCityName = '-';
            let topCityCount = 0;
            for (const [c, count] of Object.entries(cities)) {
                if (count > topCityCount) {
                    topCityCount = count;
                    topCityName = c;
                }
            }
            document.getElementById('topCity').innerText = `${topCityName} (${topCityCount})`;

            // پر کردن دراپ داون شهرها
            const citySelect = document.getElementById('cityFilter');
            citySelect.innerHTML = '<option value="all">همه شهرها</option>';
            Object.keys(cities).sort().forEach(c => {
                citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            // رسم جدول خلاصه و نمودار
            renderSummary(cities);
            
            // نمایش جدول اصلی
            applyFilters();
        }

        function renderSummary(cities) {
            const sortedCities = Object.keys(cities).sort((a,b) => cities[b] - cities[a]);
            const tbody = document.getElementById('summaryTableBody');
            const labels = [];
            const data = [];

            tbody.innerHTML = '';
            sortedCities.forEach(city => {
                const count = cities[city];
                const percent = ((count / rawData.length) * 100).toFixed(1);
                labels.push(city);
                data.push(count);

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="px-4 py-2 font-medium text-gray-800">${city}</td>
                        <td class="px-4 py-2 text-center font-bold text-blue-600">${count}</td>
                        <td class="px-4 py-2 text-center text-gray-500 dir-ltr">%${percent}</td>
                    </tr>
                `;
            });

            // نمودار
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تعداد درخواست',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display: false} },
                    scales: {
                        y: { beginAtZero: true },
                        x: { ticks: { font: { family: 'Vazirmatn' } } }
                    }
                }
            });
        }

        // 3. فیلترینگ و نمایش جدول
        function applyFilters() {
            const cityVal = document.getElementById('cityFilter').value;
            const timeVal = document.getElementById('timeFilter').value;

            // کپی از داده خام
            let temp = [...rawData];

            // فیلتر شهر
            if (cityVal !== 'all') {
                temp = temp.filter(r => r[COL_MAP.CITY] === cityVal);
            }

            // مرتب سازی پیش فرض (تاریخ نزولی - جدید به قدیم)
            temp.sort((a, b) => {
                const da = a[COL_MAP.DATE_REQ] || '';
                const db = b[COL_MAP.DATE_REQ] || '';
                return db.localeCompare(da);
            });

            // فیلتر زمانی / تعدادی
            if (timeVal !== 'all') {
                if (['3', '5', '10'].includes(timeVal)) {
                    temp = temp.slice(0, parseInt(timeVal));
                } else {
                    // محاسبه تاریخ
                    const latestDate = temp.length > 0 ? temp[0][COL_MAP.DATE_REQ] : "1404/00/00";
                    if (latestDate) {
                        let monthsToSubtract = 0;
                        if (timeVal === 'm1') monthsToSubtract = 1;
                        if (timeVal === 'm2') monthsToSubtract = 2;
                        if (timeVal === 'm3') monthsToSubtract = 3;

                        // تبدیل تاریخ شمسی رشته ای به عدد جهت مقایسه تقریبی
                        // روش ساده: کاهش ماه از رشته تاریخ
                        // فرض بر فرمت yyyy/mm/dd
                        let parts = latestDate.split('/');
                        let y = parseInt(parts[0]);
                        let m = parseInt(parts[1]);
                        let d = parts[2];

                        m -= monthsToSubtract;
                        while (m <= 0) {
                            m += 12;
                            y -= 1;
                        }
                        let sm = m < 10 ? '0'+m : m;
                        let threshold = `${y}/${sm}/${d}`;

                        temp = temp.filter(r => (r[COL_MAP.DATE_REQ] || '') >= threshold);
                    }
                }
            }

            filteredData = temp;
            document.getElementById('filteredCount').innerText = filteredData.length.toLocaleString('fa-IR');
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const reqId = row[COL_MAP.ID];
                const action = managerActions[reqId];
                const statusClass = action.status === 'تایید شده' ? 'status-approve' : 'status-reject';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition border-b";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center">
                        <button onclick="openModal('${reqId}')" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 p-2 rounded-lg transition" title="تغییر وضعیت">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                    </td>
                    <td class="px-4 py-3 font-semibold text-gray-800">${row[COL_MAP.CITY] || '-'}</td>
                    <td class="px-4 py-3 font-mono text-left text-gray-600">${row[COL_MAP.AMBULANCE_ID] || '-'}</td>
                    <td class="px-4 py-3 text-blue-600 font-medium">${row[COL_MAP.DATE_REQ] || '-'}</td>
                    <td class="px-4 py-3"><span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${row[COL_MAP.STATUS] || '-'}</span></td>
                    <td class="px-4 py-3 text-gray-500">${row[COL_MAP.DATE_REF] || '-'}</td>
                    <td class="px-4 py-3 font-mono text-xs text-gray-400">${reqId}</td>
                    <td class="px-4 py-3 text-gray-700">${row[COL_MAP.REQUESTER] || '-'}</td>
                    <td class="px-4 py-3 text-center border-r bg-gray-50">
                        <div class="flex flex-col items-center gap-1">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClass}">${action.status}</span>
                            ${action.comment ? `<span class="text-xs text-gray-500 truncate w-32" title="${action.comment}">${action.comment}</span>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. مودال و عملیات تایید
        let currentEditingId = null;

        function openModal(id) {
            currentEditingId = id;
            const data = managerActions[id];
            
            document.getElementById('modalReqId').innerText = id;
            document.getElementById('modalComment').value = data.comment;
            
            const radios = document.getElementsByName('status');
            for(let r of radios) {
                if(r.value === data.status) r.checked = true;
            }
            
            document.getElementById('actionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        function saveAction() {
            const status = document.querySelector('input[name="status"]:checked').value;
            const comment = document.getElementById('modalComment').value;

            managerActions[currentEditingId] = { status, comment };
            
            closeModal();
            renderTable(); // بروزرسانی جدول
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('actionModal')) closeModal();
        }

        // 5. مرتب سازی ستون ها
        let sortDir = {};
        function sortTable(n) {
            const keys = ['', COL_MAP.CITY, COL_MAP.AMBULANCE_ID, COL_MAP.DATE_REQ];
            const key = keys[n];
            sortDir[key] = !sortDir[key]; // Toggle

            filteredData.sort((a, b) => {
                const valA = (a[key] || '').toString();
                const valB = (b[key] || '').toString();
                
                if (valA < valB) return sortDir[key] ? -1 : 1;
                if (valA > valB) return sortDir[key] ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        // 6. خروجی ها
        function exportData(type) {
            if (type === 'excel') {
                // ترکیب داده های فیلتر شده با وضعیت مدیریتی
                const exportList = filteredData.map(row => {
                    const id = row[COL_MAP.ID];
                    const action = managerActions[id];
                    return {
                        "نام شهر": row[COL_MAP.CITY],
                        "کد آمبولانس": row[COL_MAP.AMBULANCE_ID],
                        "تاریخ ثبت": row[COL_MAP.DATE_REQ],
                        "وضعیت درخواست": row[COL_MAP.STATUS],
                        "تاریخ ارجاع": row[COL_MAP.DATE_REF],
                        "شناسه درخواست": id,
                        "کاربر": row[COL_MAP.REQUESTER],
                        "هزینه": row['برآورد هزینه'] || 0,
                        // فیلدهای اضافه شده مدیریت
                        "وضعیت تایید مدیریت": action.status,
                        "توضیحات مدیریت": action.comment
                    };
                });

                const ws = XLSX.utils.json_to_sheet(exportList);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "گزارش مدیریت");
                XLSX.writeFile(wb, "Ambulance_Report_Full.xlsx");

            } else if (type === 'image') {
                const element = document.getElementById('detailSection');
                // موقتا اسکرول جدول را حذف میکنیم تا تمام داده ها در عکس بیفتد
                const tableContainer = element.querySelector('.overflow-x-auto');
                const originalOverflow = tableContainer.style.overflow;
                tableContainer.style.overflow = 'visible';

                html2canvas(element).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Management_Dashboard.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    
                    // بازگرداندن اسکرول
                    tableContainer.style.overflow = originalOverflow;
                });
            }
        }
    </script>
</body>
</html>